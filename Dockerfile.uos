FROM macrosan/uos:v20-1070

# Ubuntu
# Install required dependencies - Combine all yum commands to reduce layers
RUN yum -y update && \
    yum install -y \
    curl \
    ca-certificates \
    tzdata \
    gtk3 \
    libappindicator-gtk3 \
    librsvg2 \
    glib \
    bison \
    unzip \
    zip \
    musl-gcc \
    wget \
    git && \
    yum clean all && \
    rm -rf /var/cache/yum
  
# Install development tools and build OpenSSL - combine to reduce layers
RUN yum install -y \
    openssl-devel \
    python3 \
    gtk3-devel \
    gdk-pixbuf2-devel \
    harfbuzz-devel \
    atk-devel \
    cairo-devel \
    glib2-devel \
    pango-devel \
    pkg-config \
    clang \
    ninja-build && \
    yum groupinstall -y "Development Tools" && \
    # 清理 yum 缓存和不必要的文件
    yum clean all && \
    rm -rf /var/cache/yum && \
    rm -rf /var/lib/yum/yumdb && \
    rm -rf /var/lib/yum/history

RUN wget https://www.python.org/ftp/python/3.12.12/Python-3.12.12.tgz && \
    tar xzf Python-3.12.12.tgz && \
    cd Python-3.12.12 && \
    ./configure --prefix=/usr/local/python3.12 && \
    make -j$(nproc) && \
    make install && \
    cd .. && \
    rm -rf Python-3.12*

# Build and install OpenSSL, clean up in same layer
RUN wget https://www.openssl.org/source/openssl-3.0.9.tar.gz && \
    tar xzf openssl-3.0.9.tar.gz && \
    cd openssl-3.0.9 && \
    CC="gcc" ./Configure \
      --prefix=/usr/local/musl \
      --libdir=lib \
      no-shared \
      no-zlib \
      no-async \
      linux-x86_64 && \
    make -j$(nproc) && \
    make install && \
    cd .. && \
    rm -rf openssl-3.0.9*


# Install meson and ninja for building, then build all static libraries and clean up
RUN pip3 install --no-cache-dir meson==0.60.0 ninja && \
    echo 'export PATH=$PATH:~/.local/bin' >> ~/.bashrc && \
    set -ex && \
    # Build GTK+
    wget https://download.gnome.org/sources/gtk+/3.24/gtk+-3.24.0.tar.xz && \
    tar xf gtk+-3.24.0.tar.xz && \
    cd gtk+-3.24.0 && \
    ./configure --enable-static --disable-shared --enable-all --with-included-immodules && \
    make -j$(nproc) && \
    make install && \
    cd .. && \
    rm -rf gtk+-3.24.0* && \
    \
    # Build Cairo
    wget https://www.cairographics.org/releases/cairo-1.16.0.tar.xz && \
    tar xf cairo-1.16.0.tar.xz && \
    cd cairo-1.16.0 && \
    ./configure --enable-static --disable-shared --enable-all && \
    make -j$(nproc) && \
    make install && \
    cd .. && \
    rm -rf cairo-1.16.0* && \
    \
    # Build Pango
    wget https://download.gnome.org/sources/pango/1.50/pango-1.50.14.tar.xz && \
    tar xf pango-1.50.14.tar.xz && \
    cd pango-1.50.14 && \
    meson setup build --default-library=static -Dintrospection=disabled -Dgtk_doc=false -Dinstall-tests=false --prefix=/usr/local && \
    ninja -C build && \
    ninja -C build install && \
    cd .. && \
    rm -rf pango-1.50.14* && \
    \
    # Build HarfBuzz
    wget https://github.com/harfbuzz/harfbuzz/releases/download/2.9.1/harfbuzz-2.9.1.tar.xz && \
    tar xf harfbuzz-2.9.1.tar.xz && \
    cd harfbuzz-2.9.1 && \
    ./configure --enable-static --disable-shared --enable-all && \
    make -j$(nproc) && \
    make install && \
    cd .. && \
    rm -rf harfbuzz-2.9.1* && \
    \
    # Build ATK
    wget https://download.gnome.org/sources/atk/2.38/atk-2.38.0.tar.xz && \
    tar xf atk-2.38.0.tar.xz && \
    cd atk-2.38.0 && \
    meson setup build-static --default-library=static -Dintrospection=false && \
    ninja -C build-static && \
    ninja -C build-static install && \
    cd .. && \
    rm -rf atk-2.38.0* && \
    \
    # Build gdk-pixbuf
    wget https://download.gnome.org/sources/gdk-pixbuf/2.42/gdk-pixbuf-2.42.10.tar.xz && \
    tar xf gdk-pixbuf-2.42.10.tar.xz && \
    cd gdk-pixbuf-2.42.10 && \
    meson setup build-static --default-library=static -Dbuiltin_loaders=all -Ddocs=false -Dman=false -Dinstalled_tests=false && \
    ninja -C build-static && \
    ninja -C build-static install && \
    cd .. && \
    rm -rf gdk-pixbuf-2.42.10* && \
    # Clean up pip cache and unnecessary files
    rm -rf /root/.cache/pip && \
    # Remove unnecessary locale files to save space
    find /usr/local/share/locale -mindepth 1 -maxdepth 1 ! -name 'en*' -exec rm -rf {} + 2>/dev/null || true && \
    # Remove gtk-doc and other documentation
    rm -rf /usr/local/share/gtk-doc && \
    rm -rf /usr/local/share/doc && \
    rm -rf /usr/local/share/man && \
    # Strip debug symbols from static libraries
    find /usr/local/lib -name "*.a" -exec strip --strip-debug {} \; 2>/dev/null || true

RUN ldd --version

RUN /usr/local/python3.12/bin/python3 -m ensurepip && \
    /usr/local/python3.12/bin/pip3 install --no-cache-dir uv 

# 1. 创建用户并指定主目录、shell
ARG USER_UID=1000
ARG USER_GID=1000

RUN groupadd -g ${USER_UID} app && \
    useradd -u ${USER_GID} -g app -m -d /home/app -s /bin/bash app

# 2. 如果程序需要写数据目录，提前赋权
RUN mkdir /data && chown app:app /data

# 3. 切换身份，后面所有指令、容器主进程都用这个用户
USER app
WORKDIR /home/app

ENV HOME=/home/app

# Install Rust with minimal profile and add targets in one layer
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal \
    && . $HOME/.cargo/env \
    && cargo -V \
    && rustup target add x86_64-unknown-linux-musl x86_64-unknown-linux-gnu \
    && rm -rf $HOME/.cargo/registry/cache \
    && rm -rf $HOME/.cargo/git/db

ENV PATH="$HOME/.cargo/bin:${PATH}"

# 安装node.js 和 Claude Code - 优化安装并清理所有缓存
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash && \
    \. "$HOME/.nvm/nvm.sh" && \
    # 安装 Node.js 22
    nvm install 22 && \
    node -v && \
    npm -v && \
    # 安装 Claude Code
    npm install -g @anthropic-ai/claude-code && \
    # 清理所有缓存和不必要的文件
    npm cache clean --force && \
    rm -rf $HOME/.npm/_cacache && \
    rm -rf $HOME/.npm/_logs && \
    rm -rf $HOME/.nvm/.cache && \
    rm -rf $HOME/.nvm/versions/node/v*/include && \
    rm -rf $HOME/.nvm/versions/node/v*/share && \
    # 删除 Node.js 文档和示例
    find $HOME/.nvm/versions/node -name "*.md" -delete && \
    find $HOME/.nvm/versions/node -name "*.txt" -delete && \
    find $HOME/.nvm/versions/node -type d -name "docs" -exec rm -rf {} + 2>/dev/null || true && \
    # 设置权限
    chmod 777 $HOME && \
    chmod -R 755 $HOME && \
    mkdir $HOME/.claude && \
    chmod -R 777 $HOME/.claude 

ENV PATH="$HOME/.local/bin:${PATH}"
    
RUN /usr/local/python3.12/bin/uv tool install specify-cli --from git+https://github.com/github/spec-kit.git && \
    specify --help

WORKDIR /app1
RUN ldd --version


